generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(cuid())
  clerkId          String?         @unique
  email            String          @unique
  firstName        String
  lastName         String
  phone            String?
  role             UserRole        @default(CUSTOMER)
  status           UserStatus      @default(ACTIVE)
  avatar           String?
  dateOfBirth      DateTime?
  preferences      Json?
  defaultLatitude  Float?
  defaultLongitude Float?
  defaultAddress   String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  lastLoginAt      DateTime?
  favorites        Favorite[]
  notifications    Notification[]
  providerProfile  Provider?
  reviews          Review[]
  searchHistory    SearchHistory[]

  @@index([defaultLatitude, defaultLongitude], map: "user_location_idx")
  @@index([role], map: "user_role_idx")
  @@index([status], map: "user_status_idx")
  @@map("users")
}

model Provider {
  id                String          @id @default(cuid())
  userId            String          @unique
  businessName      String
  businessType      String
  description       String?
  status            ProviderStatus  @default(PENDING_APPROVAL)
  phone             String
  email             String
  website           String?
  address           String
  latitude          Float
  longitude         Float
  city              String
  region            String
  postalCode        String?
  operatingHours    Json
  businessLicense   String?
  taxId             String?
  bankAccount       Json?
  acceptsBookings   Boolean         @default(true)
  minAdvanceBooking Int             @default(60)
  maxAdvanceBooking Int             @default(10080)
  rating            Float           @default(0)
  totalReviews      Int             @default(0)
  totalBookings     Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  verifiedAt        DateTime?
  reviewCount       Int             @default(0)
  favorites         Favorite[]
  notifications     Notification[]
  promotions        Promotion[]
  images            ProviderImage[]
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews           Review[]
  services          Service[]

  @@index([latitude, longitude], map: "provider_location_idx")
  @@index([status], map: "provider_status_idx")
  @@index([rating], map: "provider_rating_idx")
  @@map("providers")
}

model Service {
  id                  String         @id @default(cuid())
  providerId          String
  name                String
  description         String?
  type                ServiceType
  status              ServiceStatus  @default(ACTIVE)
  currency            String         @default("CLP")
  category            String?
  tags                String[]
  isAvailable         Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  additionalImages    String[]
  deletedAt           DateTime?
  discountedPrice     Decimal?       @db.Decimal(10, 2)
  displayOrder        Int            @default(0)
  duration            Int
  imageUrl            String?
  includedServices    String[]
  isFeatured          Boolean        @default(false)
  maxAdvanceBooking   Int?
  maxCapacity         Int            @default(1)
  minAdvanceBooking   Int?
  price               Decimal        @db.Decimal(10, 2)
  requirements        String?
  requiresAppointment Boolean        @default(false)
  notifications       Notification[]
  reviews             Review[]
  serviceImages       ServiceImage[]
  provider            Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId], map: "service_provider_idx")
  @@index([type], map: "service_type_idx")
  @@index([status], map: "service_status_idx")
  @@index([category], map: "service_category_idx")
  @@index([isAvailable], map: "service_available_idx")
  @@index([isFeatured], map: "service_featured_idx")
  @@index([deletedAt], map: "service_deleted_idx")
  @@map("services")
}

model Review {
  id                String       @id @default(cuid())
  userId            String
  providerId        String
  status            ReviewStatus @default(PENDING)
  rating            Int
  title             String?
  comment           String?
  serviceQuality    Int?
  cleanliness       Int?
  valueForMoney     Int?
  staffFriendliness Int?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  publishedAt       DateTime?
  serviceId         String?
  provider          Provider     @relation(fields: [providerId], references: [id])
  service           Service?     @relation(fields: [serviceId], references: [id])
  user              User         @relation(fields: [userId], references: [id])

  @@index([providerId], map: "review_provider_idx")
  @@index([rating], map: "review_rating_idx")
  @@map("reviews")
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  providerId String
  createdAt  DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, providerId])
  @@index([userId], map: "favorite_user_idx")
  @@map("favorites")
}

model SearchHistory {
  id        String   @id @default(cuid())
  userId    String
  query     String
  latitude  Float?
  longitude Float?
  radius    Int?
  filters   Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "search_history_user_idx")
  @@index([createdAt], map: "search_history_date_idx")
  @@map("search_history")
}

model Notification {
  id         String             @id @default(cuid())
  userId     String
  title      String
  message    String
  data       Json?
  createdAt  DateTime           @default(now())
  readAt     DateTime?
  actionUrl  String?
  providerId String?
  serviceId  String?
  status     NotificationStatus @default(UNREAD)
  updatedAt  DateTime           @updatedAt
  type       NotificationType
  provider   Provider?          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service    Service?           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "notification_user_idx")
  @@index([status], map: "notification_status_idx")
  @@index([type], map: "notification_type_idx")
  @@index([createdAt], map: "notification_created_idx")
  @@map("notifications")
}

model ProviderImage {
  id         String   @id @default(cuid())
  providerId String
  url        String
  alt        String?
  order      Int      @default(0)
  isMain     Boolean  @default(false)
  createdAt  DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId], map: "provider_image_provider_idx")
  @@map("provider_images")
}

model ServiceImage {
  id        String   @id @default(cuid())
  serviceId String
  url       String
  alt       String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId], map: "service_image_service_idx")
  @@map("service_images")
}

model Promotion {
  id            String   @id @default(cuid())
  providerId    String
  title         String
  description   String?
  discountType  String
  discountValue Decimal  @db.Decimal(10, 2)
  minOrderValue Decimal? @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2)
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  usageLimit    Int?
  usedCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  provider      Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId], map: "promotion_provider_idx")
  @@index([startDate, endDate], map: "promotion_date_range_idx")
  @@index([isActive], map: "promotion_active_idx")
  @@map("promotions")
}

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum ProviderStatus {
  ACTIVE
  INACTIVE
  PENDING_APPROVAL
  SUSPENDED
  VERIFIED
}

enum ServiceType {
  BASIC_WASH
  PREMIUM_WASH
  DETAILING
  WAXING
  INTERIOR_CLEAN
  ENGINE_CLEAN
  TIRE_CLEAN
  PAINT_PROTECTION
  CERAMIC_COATING
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  SEASONAL
  PENDING_APPROVAL
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  PRICE_DROP
  NEW_OFFER
  NEW_PROVIDER
  SYSTEM_UPDATE
  REVIEW_REQUEST
  PROMOTION
}

enum NotificationStatus {
  UNREAD
  READ
}
