name: "Performance Budget Check"

on:
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'frontend/**'
  push:
    branches: [ "main" ]
    paths:
      - 'frontend/**'

jobs:
  bundle-size:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Next.js
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: https://api.altocarwash.cl
        run: npm run build

      - name: Analyze Bundle Size
        uses: andresz1/size-limit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          directory: ./frontend
          build_script: npm run build
          skip_step: build

      - name: Upload Bundle Analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            frontend/.next/analyze/
            frontend/.next/stats.json
          retention-days: 30

  lighthouse-budget:
    name: Lighthouse Performance Budget
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: altocarwash_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      # Start backend
      - name: Setup Backend
        working-directory: ./backend
        run: |
          npm ci
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/altocarwash_test

      - name: Start Backend Server
        working-directory: ./backend
        run: |
          npm run build
          npm run start:prod &
          sleep 10
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/altocarwash_test
          NODE_ENV: test
          JWT_SECRET: test-secret-key

      # Frontend
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3000
        run: npm run build

      - name: Start Frontend Server
        working-directory: ./frontend
        run: |
          npm start &
          sleep 10

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: './frontend/.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Check Core Web Vitals
        run: |
          echo "Checking Core Web Vitals against budgets..."
          # This step would parse Lighthouse results and compare with budgets
          # For now, Lighthouse CI handles this automatically

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            // Read Lighthouse results and post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ## ðŸ“Š Performance Budget Check
              
              Lighthouse CI has completed the performance budget check.
              
              View detailed results in the artifacts.
              
              **Next Steps:**
              - Review any failing budgets
              - Optimize bundle sizes if needed
              - Check Core Web Vitals metrics
              `
            })

  web-vitals-monitor:
    name: Web Vitals Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Send Web Vitals to Analytics
        run: |
          echo "Sending Web Vitals to analytics service..."
          # This would integrate with your analytics service
          # Example: Send to Google Analytics, Vercel Analytics, etc.
