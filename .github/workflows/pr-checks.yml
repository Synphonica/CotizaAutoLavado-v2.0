name: PR Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Check for secrets
        run: |
          echo "üîç Checking for accidentally committed secrets..."
          
          # Check for .env files (except .env.example)
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.env$|\.env\..*$" | grep -v "\.env\.example$"; then
            echo "‚ùå ERROR: .env files detected in commit"
            echo "Please remove these files and follow SECURITY.md"
            exit 1
          fi
          
          # Check for common secret patterns
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "password\s*=\s*['\"][^'\"]+['\"]|api[_-]?key\s*=\s*['\"][^'\"]+['\"]|secret\s*=\s*['\"][^'\"]+['\"]"; then
            echo "‚ö†Ô∏è  WARNING: Possible secrets detected in diff"
            echo "Please review your changes carefully"
            # Don't fail, just warn
          fi
          
          echo "‚úÖ No obvious secrets detected"

      - name: üìù Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

      - name: üìä Add PR size label
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: false

  comment-coverage:
    name: Comment Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üí¨ Comment PR with coverage
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true
